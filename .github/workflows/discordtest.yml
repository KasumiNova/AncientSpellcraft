on:
  workflow_dispatch:

jobs:
  message:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Get the version
      id: get_version
      run: echo ::set-output name=VERSION::$(echo v1.4.2)

    - name: Generate Discord Announcement With Changelog
      uses: Helmisek/conventional-changelog-generator@v1.0.6-release
      id: changelog-generator
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        commit-types: "fix:Bug Fixes,feat:Features,refactor:Refactoring"
        template-path: ".github/workflows/DISCORD_CHANGELOG.tpl.md"
        current-tag: ${{ steps.get_version.outputs.VERSION }}

    - name: Write Discord Announcement to File
      uses: DamianReeves/write-file-action@master
      with:
        path: ${{ github.workspace }}/.github/DISCORD_ANNOUNCEMENT.txt
        contents: |
          ${{steps.changelog-generator.outputs.changelog}}
        write-mode: overwrite

    - name: Replace Tokens in Discord Announcement
    - uses: cschleiden/replace-tokens@v1
      with:
        files: '["**/DISCORD_ANNOUNCEMENT.txt"]'
      env:
        MOD_NAME: "${{ steps.build.outpus.name }}"
        URL: "${{ steps.build.outputs.url }}"
        FILE_ID: "${{ steps.publish.outputs.id }}"

    - name: Read Discord Announcement From File
      id: announcement-content
      uses: juliangruber/read-file-action@v1
      with:
        path: ${{ github.workspace }}/.github/DISCORD_ANNOUNCEMENT.txt

    - name: Discord Webhook Action
      uses: tsickert/discord-webhook@v4.0.0
      with:
        webhook-url: ${{ secrets.DISCORD_ANNOUNCER_WEBHOOK }}
        content: "${{ steps.announcement-content.outputs.content }}"
